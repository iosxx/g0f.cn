name: 添加友链

on:
  issues:
    types: [closed]

jobs:
  add-friend:
    if: github.event.issue.state_reason == 'completed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 解析 Issue 内容
        id: parse
        run: |
          BODY="${{ github.event.issue.body }}"
          
          NAME=$(echo "$BODY" | grep -A1 "### 网站名称" | tail -n1 | xargs)
          URL=$(echo "$BODY" | grep -A1 "### 网站地址" | tail -n1 | xargs)
          DESC=$(echo "$BODY" | grep -A1 "### 网站描述" | tail -n1 | xargs)
          AVATAR=$(echo "$BODY" | grep -A1 "### 网站图标" | tail -n1 | xargs)
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT

      - name: 添加友链到 links.json
        run: |
          jq --arg name "${{ steps.parse.outputs.name }}" \
             --arg url "${{ steps.parse.outputs.url }}" \
             --arg desc "${{ steps.parse.outputs.desc }}" \
             --arg avatar "${{ steps.parse.outputs.avatar }}" \
             '.friends += [{"name": $name, "url": $url, "src": $avatar, "des": $desc}]' \
             links.json > tmp.json && mv tmp.json links.json

      - name: 创建 Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "添加友链: ${{ steps.parse.outputs.name }}"
          branch: friendlink-${{ github.event.issue.number }}
          title: "添加友链: ${{ steps.parse.outputs.name }}"
          body: |
            自动添加友链
            
            - 网站名称: ${{ steps.parse.outputs.name }}
            - 网站地址: ${{ steps.parse.outputs.url }}
            - 网站描述: ${{ steps.parse.outputs.desc }}
            
            关闭 #${{ github.event.issue.number }}
