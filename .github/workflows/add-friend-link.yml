name: 添加友链

on:
  issues:
    types: [closed]

jobs:
  add-friend-link:
    if: github.event.issue.state == 'closed' && github.event.issue.state_reason == 'completed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 解析 Issue 内容
        id: parse
        run: |
          body="${{ github.event.issue.body }}"
          name=$(echo "$body" | grep -oP '(?<=### 网站名称\s{0,}).*' | head -1 | xargs)
          url=$(echo "$body" | grep -oP '(?<=### 网站地址\s{0,}).*' | head -1 | xargs)
          desc=$(echo "$body" | grep -oP '(?<=### 网站描述\s{0,}).*' | head -1 | xargs)
          avatar=$(echo "$body" | grep -oP '(?<=### 网站图标\s{0,}).*' | head -1 | xargs)
          
          echo "name=$name" >> $GITHUB_OUTPUT
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "desc=$desc" >> $GITHUB_OUTPUT
          echo "avatar=$avatar" >> $GITHUB_OUTPUT
      
      - name: 添加友链到 JSON
        run: |
          jq --arg name "${{ steps.parse.outputs.name }}" \
             --arg url "${{ steps.parse.outputs.url }}" \
             --arg desc "${{ steps.parse.outputs.desc }}" \
             --arg avatar "${{ steps.parse.outputs.avatar }}" \
             '. += [{"name": $name, "link": $url, "descr": $desc, "avatar": $avatar}]' \
             src/data/friend.json > tmp.json && mv tmp.json src/data/friend.json
      
      - name: 提交更改
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src/data/friend.json
          git commit -m "添加友链: ${{ steps.parse.outputs.name }}"
          git push
      
      - name: 评论 Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ 友链已添加成功！感谢您的支持！'
            })
