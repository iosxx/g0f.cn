name: 自动添加友链

on:
  issues:
    types: [closed]

jobs:
  add-friend-link:
    if: github.event.issue.state_reason == 'completed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 解析 Issue 内容
        id: parse
        run: |
          BODY="${{ github.event.issue.body }}"
          NAME=$(echo "$BODY" | grep -oP '(?<=### 网站名称\s{0,10})[^\n]+' | xargs)
          URL=$(echo "$BODY" | grep -oP '(?<=### 网站地址\s{0,10})[^\n]+' | xargs)
          DESC=$(echo "$BODY" | grep -oP '(?<=### 网站描述\s{0,10})[^\n]+' | xargs)
          AVATAR=$(echo "$BODY" | grep -oP '(?<=### 网站图标\s{0,10})[^\n]+' | xargs)
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT

      - name: 添加友链到 JSON
        run: |
          jq --arg name "${{ steps.parse.outputs.name }}" \
             --arg url "${{ steps.parse.outputs.url }}" \
             --arg desc "${{ steps.parse.outputs.desc }}" \
             --arg avatar "${{ steps.parse.outputs.avatar }}" \
             '. += [{"name": $name, "link": $url, "descr": $desc, "avatar": $avatar}]' \
             links.json > tmp.json && mv tmp.json links.json

      - name: 提交更改
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add links.json
          git commit -m "添加友链: ${{ steps.parse.outputs.name }}"
          git push

      - name: 评论 Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '✅ 友链已自动添加！感谢您的申请。'
            })
