name: å¤„ç†å‹é“¾ç”³è¯·

on:
  issues:
    types: [closed]

jobs:
  add-friend-link:
    if: github.event.issue.state_reason == 'completed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: è§£æ Issue å†…å®¹
        id: parse
        run: |
          BODY="${{ github.event.issue.body }}"
          
          NAME=$(echo "$BODY" | grep -oP '(?<=### ç½‘ç«™åç§°\s{0,10}).*' | head -1 | xargs)
          URL=$(echo "$BODY" | grep -oP '(?<=### ç½‘ç«™åœ°å€\s{0,10}).*' | head -1 | xargs)
          DESC=$(echo "$BODY" | grep -oP '(?<=### ç½‘ç«™æè¿°\s{0,10}).*' | head -1 | xargs)
          AVATAR=$(echo "$BODY" | grep -oP '(?<=### ç½‘ç«™å¤´åƒ\s{0,10}).*' | head -1 | xargs)
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "desc=$DESC" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT

      - name: æ£€å‡ºåšå®¢ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: iosxx/notion-hugo-deploy
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: æ·»åŠ å‹é“¾
        run: |
          jq --arg name "${{ steps.parse.outputs.name }}" \
             --arg url "${{ steps.parse.outputs.url }}" \
             --arg desc "${{ steps.parse.outputs.desc }}" \
             --arg avatar "${{ steps.parse.outputs.avatar }}" \
             '. += [{"name": $name, "link": $url, "descr": $desc, "avatar": $avatar}]' \
             data/links.json > tmp.json && mv tmp.json data/links.json

      - name: æäº¤æ›´æ”¹
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/links.json
          git commit -m "æ·»åŠ å‹é“¾: ${{ steps.parse.outputs.name }}"
          git push

      - name: è¯„è®º Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: 'iosxx',
              repo: 'g0f.cn',
              body: 'âœ… å‹é“¾å·²æ·»åŠ ï¼æ„Ÿè°¢æ”¯æŒ ğŸ‰'
            })