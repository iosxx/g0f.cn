name: å‹é“¾ç®¡ç†

on:
  issues:
    types: [closed]

jobs:
  add-friendlink:
    if: github.event.issue.state_reason == 'completed'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è§£æå‹é“¾ä¿¡æ¯
        id: parse
        run: |
          body="${{ github.event.issue.body }}"
          name=$(echo "$body" | grep -oP '(?<=### ç½‘ç«™åç§°\s*)[^\n]+' | xargs)
          url=$(echo "$body" | grep -oP '(?<=### ç½‘ç«™åœ°å€\s*)[^\n]+' | xargs)
          desc=$(echo "$body" | grep -oP '(?<=### ç½‘ç«™æè¿°\s*)[^\n]+' | xargs)
          avatar=$(echo "$body" | grep -oP '(?<=### ç½‘ç«™å›¾æ ‡\s*)[^\n]+' | xargs)
          
          echo "name=$name" >> $GITHUB_OUTPUT
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "desc=$desc" >> $GITHUB_OUTPUT
          echo "avatar=$avatar" >> $GITHUB_OUTPUT

      - name: æ·»åŠ å‹é“¾
        run: |
          jq --arg name "${{ steps.parse.outputs.name }}" \
             --arg url "${{ steps.parse.outputs.url }}" \
             --arg desc "${{ steps.parse.outputs.desc }}" \
             --arg avatar "${{ steps.parse.outputs.avatar }}" \
             '.friends += [{"name": $name, "url": $url, "src": $avatar, "des": $desc}]' \
             links.json > tmp.json && mv tmp.json links.json

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add links.json
          git commit -m "æ·»åŠ å‹é“¾: ${{ steps.parse.outputs.name }}"
          git push

      - name: è¯„è®ºé€šçŸ¥
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… å‹é“¾å·²è‡ªåŠ¨æ·»åŠ ï¼æ„Ÿè°¢æ”¯æŒ ğŸ‰'
            })
