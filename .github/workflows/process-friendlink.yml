name: Process Friendlink Application

on:
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Job 1: 处理审批评论，添加 approved 标签
  approve-application:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.issue.labels.*.name, 'friendlink')
    
    steps:
      - name: Check approval comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment;
            const commentBody = comment.body.toLowerCase().trim();
            
            // 检查是否包含 /approve 命令
            if (!commentBody.includes('/approve')) {
              console.log('Comment does not contain /approve command');
              return;
            }
            
            // 检查是否已经有 approved 标签
            const hasApproved = context.payload.issue.labels.some(label => label.name === 'approved');
            if (hasApproved) {
              console.log('Issue already has approved label');
              return;
            }
            
            // 只有仓库所有者或协作者可以批准
            const isApprover = ['OWNER', 'COLLABORATOR', 'MEMBER'].includes(comment.author_association);
            
            if (!isApprover) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '❌ 抱歉，只有仓库维护者可以批准友链申请。'
              });
              return;
            }
            
            // 添加 approved 标签
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['approved']
            });
            
            // 移除 pending 标签
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'pending'
              });
            } catch (error) {
              console.log('Pending label not found or already removed');
            }
            
            // 添加确认评论
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '✅ 友链申请已批准！正在自动处理...'
            });

  # Job 2: 处理已批准的申请，更新 links.json 并创建 PR
  process-approved-application:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issues' && github.event.action == 'labeled' && github.event.label.name == 'approved') &&
      contains(github.event.issue.labels.*.name, 'friendlink')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse issue and update links.json
        id: parse-issue
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const fs = require('fs');
            const issue = context.payload.issue;
            
            // 检查是否已经处理过（通过检查是否有自动PR）
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number
            });
            
            const alreadyProcessed = comments.data.some(c => 
              c.body.includes('友链申请已处理，自动 PR 已创建')
            );
            
            if (alreadyProcessed) {
              console.log('This issue has already been processed');
              return JSON.stringify({ updated: false });
            }
            
            // 解析 Issue 内容
            const body = issue.body;
            
            // 提取表单数据（针对 YAML 表单格式）
            const extractField = (fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*([\\s\\S]*?)(?=###|$)`, 'i');
              const match = body.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const blogName = extractField('博客名称');
            const blogUrl = extractField('博客地址');
            const blogDescription = extractField('博客描述');
            const avatarInput = extractField('头像地址');
            const categoryRaw = extractField('友链分类');
            
            // 验证必填字段
            if (!blogName || !blogUrl) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '❌ 错误：缺少必填字段（博客名称或博客地址）。'
              });
              return JSON.stringify({ updated: false });
            }
            
            // 解析分类
            let category = 'friends';
            if (categoryRaw.includes('experts') || categoryRaw.includes('大佬')) {
              category = 'experts';
            } else if (categoryRaw.includes('groups') || categoryRaw.includes('团体')) {
              category = 'groups';
            }
            
            // 解析头像
            let avatarData = {};
            if (avatarInput.startsWith('md5:')) {
              avatarData.md5 = avatarInput.replace('md5:', '').trim();
            } else if (avatarInput) {
              avatarData.src = avatarInput.trim();
            }
            
            // 构建友链对象
            const newLink = {
              name: blogName,
              url: blogUrl,
              ...avatarData,
              des: blogDescription || ''
            };
            
            // 读取现有的 links.json
            const linksData = JSON.parse(fs.readFileSync('links.json', 'utf8'));
            
            // 检查是否已存在
            const categoryLinks = linksData[category] || [];
            const exists = categoryLinks.some(link => link.url === blogUrl);
            
            if (exists) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: '⚠️ 该博客链接已存在于友链列表中！'
              });
              return JSON.stringify({ updated: false });
            }
            
            // 添加新友链
            categoryLinks.push(newLink);
            linksData[category] = categoryLinks;
            
            // 写入文件
            fs.writeFileSync('links.json', JSON.stringify(linksData, null, 4) + '\n');
            
            // 返回结果
            return JSON.stringify({
              updated: true,
              blog_name: blogName,
              category: category
            });

      - name: Set outputs
        id: outputs
        run: |
          $result = '${{ steps.parse-issue.outputs.result }}' | ConvertFrom-Json
          echo "updated=$($result.updated)" >> $env:GITHUB_OUTPUT
          echo "blog_name=$($result.blog_name)" >> $env:GITHUB_OUTPUT
          echo "category=$($result.category)" >> $env:GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.outputs.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add friendlink: ${{ steps.outputs.outputs.blog_name }}"
          branch: friendlink-${{ github.event.issue.number }}
          delete-branch: true
          title: "Add friendlink: ${{ steps.outputs.outputs.blog_name }}"
          body: |
            ## 友链申请自动处理
            
            此 PR 由 GitHub Actions 自动生成，用于添加新的友链。
            
            **来源 Issue:** #${{ github.event.issue.number }}
            **博客名称:** ${{ steps.outputs.outputs.blog_name }}
            **分类:** ${{ steps.outputs.outputs.category }}
            
            请检查 `links.json` 的变更是否正确。
            
            合并后，友链数据会自动同步到博客站点。
          labels: friendlink,auto-pr

      - name: Comment on Issue
        if: steps.outputs.outputs.updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '✅ 友链申请已处理，自动 PR 已创建！\n\n请检查 Pull Request 并合并，合并后将自动同步到博客站点。'
            });
