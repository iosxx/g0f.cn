name: Sync to Hugo Site

on:
  push:
    branches:
      - main
    paths:
      - 'links.json'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout links repository
        uses: actions/checkout@v4
        with:
          path: links-repo
      
      - name: Checkout Hugo site repository
        uses: actions/checkout@v4
        with:
          repository: iosxx/notion-hugo-deploy
          token: ${{ secrets.HUGO_SITE_PAT }}
          path: hugo-site
      
      - name: Sync links.json to Hugo site
        run: |
          # å¤åˆ¶ links.json åˆ° Hugo ç«™ç‚¹çš„ static ç›®å½•
          mkdir -p hugo-site/static
          cp links-repo/links.json hugo-site/data/links.json
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼ˆåŒ…æ‹¬æ–°æ–‡ä»¶ï¼‰
          cd hugo-site
          git add static/links.json
          if git diff --cached --quiet; then
            echo "No changes in links.json"
            echo "has_changes=false" >> $GITHUB_ENV
          else
            echo "Changes detected in links.json"
            echo "has_changes=true" >> $GITHUB_ENV
          fi
      
      - name: Commit and push changes
        if: env.has_changes == 'true'
        run: |
          cd hugo-site
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "chore: sync links.json from g0f.cn repository"
          git push
      
      - name: Comment on related PR
        if: env.has_changes == 'true' && github.event_name == 'push' && contains(github.event.head_commit.message, 'friendlink')
        uses: actions/github-script@v7
        with:
          script: |
            const commitMessage = context.payload.head_commit.message;
            const issueMatch = commitMessage.match(/#(\d+)/);
            
            if (issueMatch) {
              const issueNumber = parseInt(issueMatch[1]);
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: 'ğŸ‰ å‹é“¾å·²æˆåŠŸæ·»åŠ å¹¶åŒæ­¥åˆ°åšå®¢ç«™ç‚¹ï¼\n\næ•°æ®å·²è‡ªåŠ¨æ¨é€åˆ° Hugo ç«™ç‚¹ä»“åº“ï¼Œç«™ç‚¹æ­£åœ¨é‡æ–°æ„å»ºä¸­...\n\næ„Ÿè°¢ä½ çš„ç”³è¯·ï¼'
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                state: 'closed'
              });
            }
      
      - name: Notify sync completion
        if: env.has_changes == 'true'
        run: |
          echo "âœ… links.json has been synced to notion-hugo-deploy repository"
          echo "ğŸš€ Hugo site deployment workflow will be triggered automatically"
